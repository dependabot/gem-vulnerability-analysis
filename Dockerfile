FROM ubuntu

RUN apt-get update && apt-get install -y software-properties-common

# Install Ruby 2.4
RUN apt-add-repository ppa:brightbox/ruby-ng && apt-get update
RUN apt-get install -y ruby2.4 ruby2.4-dev build-essential zlib1g-dev liblzma-dev tzdata

# Install iruby
RUN gem install cztop

RUN apt-get install -y git libzmq-dev autoconf pkg-config libtool libffi-dev
RUN cd /opt && \
  git clone https://github.com/zeromq/czmq && \
  cd czmq && \
  ./autogen.sh && ./configure && make && make install

RUN gem install iruby bundler rake

# Install node (shouldn't be necessary, but Rails wants it)
RUN apt-get install -y nodejs

# Install jupyter
RUN apt-get install -y python3-pip && pip3 install jupyter

# Install postgres
RUN apt-get install -y wget && wget -q https://www.postgresql.org/media/keys/ACCC4CF8.asc -O - | apt-key add -
RUN echo "deb http://apt.postgresql.org/pub/repos/apt/ jessie-pgdg main" >> /etc/apt/sources.list.d/pgdg.list
RUN apt-get update -qq && apt-get install -y postgresql-client-9.6 libpq-dev

# Become an unprivileged user
RUN useradd -m -d /home/jupyter -s /bin/bash jupyter
USER jupyter
RUN mkdir /home/jupyter/notebooks
WORKDIR /home/jupyter/notebooks

# Configure jupyter
RUN jupyter notebook --generate-config
RUN echo "c.NotebookApp.ip = '*'" >> ~/.jupyter/jupyter_notebook_config.py

# Set up the Rails app
RUN git clone https://github.com/rubysec/rubysec.com

WORKDIR rubysec.com
RUN bundle install --path=vendor
RUN echo "gem 'gems'\ngem 'cztop'\ngem 'iruby'" >> Gemfile && \
  sed -i -e '/unicorn/d' Gemfile && \
  bundle install --path=vendor

RUN bundle exec iruby register --force && \
  jupyter kernelspec install --user ~/.ipython/kernels/ruby


COPY start.sh .
USER root
RUN chown jupyter start.sh
RUN chmod u+x start.sh
USER jupyter
CMD "./start.sh"
